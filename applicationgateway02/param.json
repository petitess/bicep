{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"config": {
			"value": {
				"product": "infra",
				"location": "we",
				"tags": {
					"Product": "Common Infrastructure",
					"Environment": "Development",
					"CostCenter": "54321"
				},
				"vnet": {
					"addressPrefixes": [
						"10.100.6.0/24",
						"10.100.10.0/24"
					],
					"subnets": [
						{
							"name": "snet-agw",
							"addressPrefix": "10.100.6.0/24",
							"routes": [
								{
									"name": "udr-private-a",
									"properties": {
										"addressPrefix": "10.0.0.0/8",
										"nextHopType": "VirtualAppliance",
										"nextHopIpAddress": "10.100.9.4"
									}
								},
								{
									"name": "udr-private-b",
									"properties": {
										"addressPrefix": "172.16.0.0/12",
										"nextHopType": "VirtualAppliance",
										"nextHopIpAddress": "10.100.9.4"
									}
								},
								{
									"name": "udr-private-c",
									"properties": {
										"addressPrefix": "192.168.0.0/16",
										"nextHopType": "VirtualAppliance",
										"nextHopIpAddress": "10.100.9.4"
									}
								}
							],
							"rules": [
								{
									"name": "nsgsr-allow-gatewaymanager-inbound",
									"properties": {
										"access": "Allow",
										"sourceAddressPrefix": "GatewayManager",
										"sourcePortRange": "*",
										"destinationAddressPrefix": "*",
										"destinationPortRange": "65200-65535",
										"protocol": "Tcp",
										"priority": 100,
										"direction": "Inbound"
									}
								},
								{
									"name": "nsgsr-allow-azureloadbalancer-inbound",
									"properties": {
										"access": "Allow",
										"sourceAddressPrefix": "AzureLoadBalancer",
										"sourcePortRange": "*",
										"destinationAddressPrefix": "*",
										"destinationPortRange": "*",
										"protocol": "*",
										"priority": 200,
										"direction": "Inbound"
									}
								}
							],
							"defaultRules": "Inbound"
						},
						{
							"name": "snet-apim",
							"addressPrefix": "10.100.10.0/27",
							"delegation": "Microsoft.ApiManagement/service",
							"serviceEndpoints": [
								{
									"service": "Microsoft.Web"
								},
								{
									"service": "Microsoft.KeyVault"
								}
							],
							"routes": [],
							"rules": []
						},
						{
							"name": "snet-pep",
							"addressPrefix": "10.100.10.32/27"
						},
						{
							"name": "snet-mgmt",
							"addressPrefix": "10.100.10.64/27"
						}
					]
				},
				"afwp": {
					"ruleCollections": [
						{
							"name": "infra-waf",
							"priority": 100,
							"ruleCollectionType": "FirewallPolicyFilterRuleCollection",
							"action": {
								"type": "Allow"
							},
							"rules": [
								{
									"name": "AllowWeb",
									"ruleType": "ApplicationRule",
									"protocols": [
										{
											"port": 443,
											"protocolType": "Https"
										},
										{
											"port": 80,
											"protocolType": "Http"
										}
									],
									"sourceAddresses": [
										"10.100.6.0/24"
									],
									"targetFqdns": [
										"app.domain.com",
										"web.domain.com"
									]
								},
								{
									"name": "AllowSql",
									"ruleType": "ApplicationRule",
									"protocols": [
										{
											"port": 1433,
											"protocolType": "Mssql"
										}
									],
									"sourceAddresses": [
										"10.100.6.0/24"
									],
									"targetFqdns": [
										"sql.domain.com"
									]
								},
								{
									"name": "AllowGP",
									"ruleType": "ApplicationRule",
									"protocols": [
										{
											"port": 443,
											"protocolType": "Https"
										}
									],
									"sourceAddresses": [
										"10.100.6.0/24",
										"10.100.10.0/24"
									],
									"targetFqdns": [
										"www.gp.se"
									]
								},
								{
									"name": "AllowAB",
									"ruleType": "ApplicationRule",
									"protocols": [
										{
											"port": 443,
											"protocolType": "Https"
										},
										{
											"port": 80,
											"protocolType": "Http"
										}
									],
									"sourceAddresses": [
										"10.100.6.0/24",
										"10.100.10.0/24"
									],
									"targetFqdns": [
										"www.aftonbladet.se"
									]
								}
							]
						}
					]
				},
				"waf": {
					"ruleGroupOverrides": [
						{
							"ruleGroupName": "REQUEST-920-PROTOCOL-ENFORCEMENT",
							"rules": [
								{
									"ruleId": "920100",
									"state": "Disabled"
								}
							]
						},
						{
							"ruleGroupName": "REQUEST-931-APPLICATION-ATTACK-RFI",
							"rules": [
								{
									"ruleId": "931130",
									"state": "Disabled"
								}
							]
						},
						{
							"ruleGroupName": "REQUEST-942-APPLICATION-ATTACK-SQLI",
							"rules": [
								{
									"ruleId": "942100",
									"state": "Disabled"
								},
								{
									"ruleId": "942110",
									"state": "Disabled"
								},
								{
									"ruleId": "942180",
									"state": "Disabled"
								},
								{
									"ruleId": "942260",
									"state": "Disabled"
								},
								{
									"ruleId": "942370",
									"state": "Disabled"
								},
								{
									"ruleId": "942440",
									"state": "Disabled"
								}
							]
						}
					],
					"customRules": [
						{
							"name": "internal",
							"priority": 10,
							"ruleType": "MatchRule",
							"action": "Block",
							"matchConditions": [
								{
									"matchVariables": [
										{
											"variableName": "RequestUri"
										}
									],
									"operator": "BeginsWith",
									"matchValues": [
										"/internal-"
									]
								}
							]
						}
					]
				},
				"webApplicationFirewallConfiguration": {
					"enabled": true,
					"firewallMode": "Prevention",
					"requestBodyCheck": true,
					"maxRequestBodySizeInKb": 128,
					"fileUploadLimitInMb": 100,
					"ruleSetType": "OWASP",
					"ruleSetVersion": 3.2,
					"ruleGroupOverrides": []
				},
				"agw": {
					"vnetName": "vnet-infra-spoke-dev-we-01",
					"vnetResourceGroup": "rg-infra-spoke-dev-we-01",
					"snetName": "snet-agw",
					"pipSku": {
						"name": "Standard",
						"tier": "Regional"
					},
					"pipAllocationMethod": "Static",
					"sku": {
						"name": "WAF_v2",
						"tier": "WAF_v2",
						"capacity": 2
					},
					"autoscaleConfiguration": {
						"minCapacity": 0,
						"maxCapacity": 2
					},
					"http2": true,
					"certificateName": "certapp",
					"sslPolicy": {
						"policyType": "Predefined",
						"policyName": "AppGwSslPolicy20170401S"
					},
					"portHttp": 80,
					"portHttps": 443,
					"firewallConfiguration": {
						"enabled": true,
						"firewallMode": "Prevention",
						"ruleSetType": "OWASP",
						"ruleSetVersion": "3.2",
						"requestBodyCheck": true,
						"maxRequestBodySizeInKb": 128,
						"fileUploadLimitInMb": 100
					},
					"sites": [
						{
							"name": "api",
							"hostname": "test-api.company.com",
							"probePath": "/status-0123456789abcdef",
							"backendAddresses": [
								{
								  "fqdn": "app-api-prod-01.azurewebsites.net"
								}
							  ],
							"firewallConfiguration": {
								"ruleGroupOverrides": [],
								"customRules": [
									{
										"name": "internal",
										"priority": 10,
										"ruleType": "MatchRule",
										"action": "Block",
										"matchConditions": [
											{
												"matchVariables": [
													{
														"variableName": "RequestUri"
													}
												],
												"operator": "BeginsWith",
												"matchValues": [
													"/internal-"
												]
											}
										]
									}
								]
							}
						},
						{
							"name": "portal",
							"hostname": "portal-test-api.company.com",
							"probePath": "/internal-status-0123456789abcdef",
							"backendAddresses": [
								{
								  "ipAddress": "1.2.3.4"
								}
							  ],
							"firewallConfiguration": {
								"ruleGroupOverrides": [
									{
										"ruleGroupName": "REQUEST-920-PROTOCOL-ENFORCEMENT",
										"rules": [
											{
												"ruleId": "920300",
												"state": "Disabled"
											},
											{
												"ruleId": "920320",
												"state": "Disabled"
											}
										]
									},
									{
										"ruleGroupName": "REQUEST-941-APPLICATION-ATTACK-XSS",
										"rules": [
											{
												"ruleId": "941100",
												"state": "Disabled"
											}
										]
									},
									{
										"ruleGroupName": "REQUEST-942-APPLICATION-ATTACK-SQLI",
										"rules": [
											{
												"ruleId": "942200",
												"state": "Disabled"
											},
											{
												"ruleId": "942260",
												"state": "Disabled"
											},
											{
												"ruleId": "942340",
												"state": "Disabled"
											},
											{
												"ruleId": "942370",
												"state": "Disabled"
											},
											{
												"ruleId": "942450",
												"state": "Disabled"
											}
										]
									}
								],
								"customRules": []
							}
						}
					]
				}
			}
		}
	}
}